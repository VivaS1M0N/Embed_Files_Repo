<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tarjeta de Recursos - Mejorada</title>
  <style>
    :root {
      --pad: 12px;
      --muted: rgba(226, 232, 240, 0.64);
      --text: var(--cu-text-color, #e2e8f0);
      --accent: var(--cu-accent-color, #94a3ff);
      --row-hover: rgba(148, 163, 184, 0.14);
      --row-border: rgba(148, 163, 184, 0.18);
      --badge-bg: rgba(148, 163, 184, 0.16);
      --badge-text: rgba(226, 232, 240, 0.78);
      --avatar-bg: rgba(148, 163, 184, 0.25);
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      font-size: 13px;
      line-height: 1.5;
      background: transparent;
      color: var(--text);
      display: flex;
      width: 100%;
      min-height: 100%;
    }

    .card {
      width: 100%;
      flex: 1 1 auto;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: var(--pad) 0;
    }

    .owner-bar {
      display: flex;
      justify-content: flex-end;
      padding: 0 var(--pad);
    }

    .ghost-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: rgba(148, 163, 184, 0.12);
      color: inherit;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .ghost-btn.locked {
      background: rgba(148, 163, 184, 0.08);
    }

    .ghost-btn[data-state='ready'] {
      background: rgba(148, 163, 184, 0.18);
      border-color: rgba(148, 163, 184, 0.24);
    }

    .ghost-btn[data-state='open'] {
      background: rgba(148, 163, 184, 0.28);
      border-color: rgba(148, 163, 184, 0.3);
    }

    .ghost-btn:hover {
      background: rgba(148, 163, 184, 0.2);
      border-color: rgba(148, 163, 184, 0.22);
    }

    .ghost-btn svg {
      opacity: 0.85;
    }

    .drawer {
      margin: 0 var(--pad);
      display: none;
      flex-direction: column;
      gap: 14px;
      padding: 14px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.34);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .drawer.open {
      display: flex;
    }

    .drawer h2 {
      margin: 0;
      font-size: 12px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .form-group {
      display: grid;
      gap: 8px;
    }

    .form-group label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      font-size: 13px;
      outline: none;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .form-actions button {
      flex: 1 1 auto;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(148, 163, 184, 0.16);
      color: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .form-actions button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .form-actions button.primary {
      background: linear-gradient(135deg, rgba(148, 163, 255, 0.95), rgba(118, 134, 255, 0.8));
      border-color: transparent;
      color: #0b1220;
    }

    .form-actions button.danger {
      color: #fecdd3;
      background: rgba(239, 68, 68, 0.18);
      border-color: rgba(239, 68, 68, 0.24);
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    #empty {
      padding: 12px var(--pad) 0;
    }

    ul.resources {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .resource {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px var(--pad);
      border-bottom: 1px solid transparent;
      border-radius: 10px;
      transition: background 0.15s ease;
    }

    .resource+.resource {
      border-top: 1px solid rgba(148, 163, 184, 0.06);
    }

    .resource:hover {
      background: var(--row-hover);
    }

    .resource.dragging {
      opacity: 0.45;
    }

    .resource a {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
      min-width: 0;
    }

    .badge {
      min-width: 36px;
      padding: 4px 6px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 10px;
      text-align: center;
      background: var(--badge-bg);
      color: var(--badge-text);
      font-weight: 600;
    }

    .primary-text {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
    }

    .secondary-text {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1 1 auto;
      min-width: 0;
    }

    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: rgba(15, 23, 42, 0.86);
      background: var(--avatar-bg);
    }

    .owner-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }

    .tiny-btn {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(15, 23, 42, 0.4);
      color: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .tiny-btn:hover {
      background: rgba(148, 163, 184, 0.28);
    }

    .tiny-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .hidden {
      display: none !important;
    }

    .auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .auth-form {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .auth-form h2 {
      margin: 0;
      font-size: 16px;
      text-align: center;
    }

    .auth-form input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
    }

    .auth-form button {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: #0b1220;
      font-weight: 600;
      cursor: pointer;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--avatar-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 10px;
    }

    .permission-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .permission-admin {
      background: var(--success);
      color: #0b1220;
    }

    .permission-editor {
      background: var(--warning);
      color: #0b1220;
    }

    .permission-viewer {
      background: var(--muted);
      color: #0b1220;
    }

    .admin-controls {
      display: flex;
      gap: 8px;
      margin-left: 12px;
      padding-left: 12px;
      border-left: 1px solid rgba(148, 163, 184, 0.2);
    }

    .admin-btn {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(148, 163, 184, 0.1);
      color: inherit;
      font-size: 11px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .admin-btn:hover {
      background: rgba(148, 163, 184, 0.2);
    }

    /* === Acceso de emergencia (candado) ‚Äî robusto === */
	#emergency-access {
	  position: fixed;
	  bottom: 12px;
	  right: 12px;
	  z-index: 2147483647;
	  pointer-events: auto;
	}

	#emergency-access a {
	  display: inline-flex;
	  align-items: center;
	  justify-content: center;
	  width: 60px;              /* ‚Üë antes 32px */
	  height: 60px;             /* ‚Üë antes 32px */
	  padding: 0;
	  border-radius: 50%;
	  background: rgba(0, 0, 0, 0.45);
	  text-decoration: none;
	  line-height: 1;
	  opacity: 0.8;
	  transition: opacity 0.2s ease, transform 0.2s ease, background 0.2s ease;
	  color: var(--text);
	  box-shadow: 0 2px 8px rgba(0,0,0,0.35);
	  -webkit-tap-highlight-color: transparent;
	}

	#emergency-access a:hover,
	#emergency-access a:focus {
	  opacity: 1;
	  transform: scale(1.05);
	  background: rgba(0, 0, 0, 0.6);
	  outline: none;
	}

	/* El logo se adapta al tama√±o del bot√≥n */
	#emergency-access a img {
	  width: 95%;               /* se hace peque√±o relativo al bot√≥n */
	  height: 95%;
	  object-fit: contain;
	  display: block;
	  pointer-events: none;     /* no bloquea el click del bot√≥n */
	}



    @media (max-width: 480px) {
      body {
        font-size: 12px;
      }

      .card {
        gap: 10px;
      }

      .ghost-btn {
        font-size: 11px;
        padding: 5px 8px;
      }

      .admin-controls {
        flex-direction: column;
        gap: 4px;
      }
    }
  </style>
</head>

<body>
  <div class="card" id="card">
    <div class="owner-bar" id="owner-bar">
      <div class="user-info" id="user-info" style="display: none;">
        <div class="user-avatar" id="user-avatar"></div>
        <span id="user-name"></span>
        <span class="permission-badge" id="user-permission"></span>
        <div class="admin-controls" id="admin-controls" style="display: none;">
          <button class="admin-btn" id="toggle-login-btn" type="button">üëÅÔ∏è Ocultar Login</button>
          <button class="admin-btn" id="logout-btn" type="button">üîì Cerrar sesi√≥n</button>
        </div>
      </div>
      <button class="ghost-btn locked" id="owner-toggle" type="button">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 11H7a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-7a1 1 0 0 0-1-1ZM15 11V8a3 3 0 1 0-6 0v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span id="owner-toggle-label">Iniciar sesi√≥n</span>
      </button>
    </div>

    <div class="drawer" id="drawer" aria-hidden="true">
      <div class="form-group">
        <h2>Archivos</h2>
        <input id="file" type="file" multiple />
        <div class="form-actions">
          <button class="primary" id="upload" type="button">Subir archivos</button>
        </div>
      </div>
      <div class="form-group">
        <h2>Accesos directos</h2>
        <label for="shortcut-name">Nombre</label>
        <input id="shortcut-name" type="text" placeholder="Ej. Manual de marca" />
        <label for="shortcut-url">URL</label>
        <input id="shortcut-url" type="url" placeholder="https://app.clickup.com/..." />
        <label for="shortcut-kind">Tipo</label>
        <select id="shortcut-kind">
          <option value="lista">Lista</option>
          <option value="carpeta">Carpeta</option>
          <option value="documento">Documento</option>
          <option value="otro">Otro</option>
        </select>
        <div class="form-actions">
          <button id="add-shortcut" type="button">Guardar acceso</button>
          <button class="danger" id="clear" type="button">Vaciar todo</button>
        </div>
      </div>
    </div>

    <div id="empty" class="muted">A√±ade archivos o accesos para que todo tu equipo pueda consultarlos aqu√≠.</div>
    <ul class="resources" id="list"></ul>
  </div>

  <div class="auth-modal hidden" id="auth-modal">
    <div class="auth-form">
      <h2>Autenticaci√≥n requerida</h2>
      <input type="text" id="auth-username" placeholder="Nombre de usuario" />
      <input type="password" id="auth-password" placeholder="Contrase√±a" />
      <button id="auth-submit">Iniciar sesi√≥n</button>
      <div id="auth-error" class="muted" style="color: var(--error); display: none;">Credenciales incorrectas</div>
    </div>
  </div>

  <script>
    // ===== CONFIGURACI√ìN DE SEGURIDAD =====
    const AUTHORIZED_USERS = {
      "Simon": {
        password: "T3chAdm1n2025",
        name: "Simon",
        permission: "admin",
        isCreator: true
      },
      "editor1": {
        password: "editor123",
        name: "Editor 1",
        permission: "editor",
        isCreator: false
      },
      "viewer1": {
        password: "viewer123",
        name: "Lector 1",
        permission: "viewer",
        isCreator: false
      }
    };

    // Configuraci√≥n de seguridad MEJORADA
    const SECURITY_CONFIG = {
      sessionTimeout: 60 * 60 * 1000,
      encryptionKey: "clave-secreta-de-encriptacion",
      requireAuthForView: false, // ‚Üê Cambiado a false para que todos vean
      hideLoginForNonCreators: true,
      showLoginButton: localStorage.getItem('showLoginButton') !== 'false' // ‚Üê Nueva preferencia
    };

    // ===== FIN DE CONFIGURACI√ìN =====

    const params = new URLSearchParams(location.search);
    const cardKey = params.get('key') || 'general';
    const storageKey = `clickup_resources_card:${cardKey}`;
    const sessionKey = storageKey + ':session';
    const state = { resources: [] };

    const $ = (q) => document.querySelector(q);
	
	//Logo con Imagen
	const LOGO_URL = "https://vivas1m0n.github.io/Embed_Files_Repo/images/logo%20redesign%20no%20bg%20min.png";


    // Estado de la aplicaci√≥n
    let currentUser = null;
    let drawerOpen = false;
    let sessionTimeoutId = null;

    // Nombres amigables para las tarjetas
    const cardNames = {
      'aboutus': 'About Us',
      'ventas': 'Documentaci√≥n de Ventas',
      'operaciones': 'Documentaci√≥n de Operaciones',
      'rrhh': 'Documentaci√≥n de RRHH/Finanzas',
      'general': 'General'
    };

    // === NUEVO: Funciones para el acceso de emergencia ===
    function createEmergencyAccess() {
      if ($('#emergency-access')) return; // Ya existe
      
      const emergencyAccess = document.createElement('div');
      emergencyAccess.id = 'emergency-access';
      emergencyAccess.style.display = 'none'; // Oculto por defecto
	  emergencyAccess.innerHTML = `
		<a href="#" id="show-login" title="Acceso administrativo" aria-label="Acceso administrativo">
		  <img src="${LOGO_URL}" alt="Viva" />
		</a>
	  `;

      document.body.appendChild(emergencyAccess);
      
      $('#show-login').addEventListener('click', function(e) {
        e.preventDefault();
        showAuthModal();
      });
    }

    function removeEmergencyAccess() {
      const emergency = $('#emergency-access');
      if (emergency) emergency.remove();
    }

    function updateEmergencyAccess() {
      const emergency = $('#emergency-access');
      if (emergency) {
        // Mostrar solo si no hay usuario y el login est√° oculto
        emergency.style.display = (!currentUser && !SECURITY_CONFIG.showLoginButton) ? 'block' : 'none';
      }
    }

    // Utilidades de encriptaci√≥n b√°sica
    function simpleEncrypt(text, key) {
      let result = '';
      for (let i = 0; i < text.length; i++) {
        result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
      }
      return btoa(result);
    }

    function simpleDecrypt(encryptedText, key) {
      try {
        const text = atob(encryptedText);
        let result = '';
        for (let i = 0; i < text.length; i++) {
          result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return result;
      } catch (e) {
        return null;
      }
    }

    // === FUNCI√ìN MEJORADA: Control de visibilidad del login ===
    function toggleLoginVisibility() {
      SECURITY_CONFIG.showLoginButton = !SECURITY_CONFIG.showLoginButton;
      localStorage.setItem('showLoginButton', SECURITY_CONFIG.showLoginButton);
	  updateEmergencyAccess();
      
      const toggleBtn = $('#toggle-login-btn');
      toggleBtn.textContent = SECURITY_CONFIG.showLoginButton ? 
        'üëÅÔ∏è Ocultar Login' : 'üëÅÔ∏è Mostrar Login';
      
      updateUI();
    }

    // === FUNCI√ìN MEJORADA: Decide si mostrar el bot√≥n de login ===
    function shouldShowLoginButton() {
      // Si la configuraci√≥n global dice ocultar
      if (!SECURITY_CONFIG.showLoginButton) {
        // Crear acceso de emergencia si no hay usuario
        if (!currentUser) {
          createEmergencyAccess();
        }
        return false;
      }
      
      // Eliminar acceso de emergencia si se muestra el bot√≥n normal
      removeEmergencyAccess();
      
      // L√≥gica original
      if (SECURITY_CONFIG.hideLoginForNonCreators) {
        const hasCreatorUser = Object.values(AUTHORIZED_USERS).some(user => user.isCreator);
        return hasCreatorUser;
      }
      return true;
    }

    // Gesti√≥n de sesiones
    function startSession(user) {
      currentUser = user;
      const sessionData = {
        user: user.username,
        timestamp: Date.now(),
        expires: Date.now() + SECURITY_CONFIG.sessionTimeout
      };
      
      const encryptedSession = simpleEncrypt(JSON.stringify(sessionData), SECURITY_CONFIG.encryptionKey);
      sessionStorage.setItem(sessionKey, encryptedSession);
      
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      sessionTimeoutId = setTimeout(endSession, SECURITY_CONFIG.sessionTimeout);
      
      updateUI();
    }

    function checkSession() {
      const encryptedSession = sessionStorage.getItem(sessionKey);
      if (!encryptedSession) return false;
      
      const sessionDataStr = simpleDecrypt(encryptedSession, SECURITY_CONFIG.encryptionKey);
      if (!sessionDataStr) {
        endSession();
        return false;
      }
      
      try {
        const sessionData = JSON.parse(sessionDataStr);
        
        if (Date.now() > sessionData.expires) {
          endSession();
          return false;
        }
        
        if (!AUTHORIZED_USERS[sessionData.user]) {
          endSession();
          return false;
        }
        
        currentUser = {
          username: sessionData.user,
          ...AUTHORIZED_USERS[sessionData.user]
        };
        
        startSession(currentUser);
        return true;
      } catch (e) {
        endSession();
        return false;
      }
    }

    function endSession() {
      currentUser = null;
      sessionStorage.removeItem(sessionKey);
      if (sessionTimeoutId) {
        clearTimeout(sessionTimeoutId);
        sessionTimeoutId = null;
      }
      updateUI();
    }

    function authenticate(username, password) {
      if (!AUTHORIZED_USERS[username]) {
        return { success: false, error: "Usuario no encontrado" };
      }
      
      const user = AUTHORIZED_USERS[username];
      if (user.password !== password) {
        return { success: false, error: "Contrase√±a incorrecta" };
      }
      
      return { 
        success: true, 
        user: {
          username,
          ...user
        }
      };
    }

    function hasPermission(action) {
      if (!currentUser) return false;
      
      switch (currentUser.permission) {
        case 'admin': return true;
        case 'editor': return action !== 'clear';
        case 'viewer': return action === 'view';
        default: return false;
      }
    }

    // === FUNCI√ìN MEJORADA: Actualizaci√≥n de la interfaz ===
    function updateUI() {
      const userInfo = $('#user-info');
      const ownerToggle = $('#owner-toggle');
      const drawer = $('#drawer');
      const adminControls = $('#admin-controls');
      
      // Actualizar acceso de emergencia
      updateEmergencyAccess();
      
      if (currentUser) {
        // Mostrar informaci√≥n del usuario
        userInfo.style.display = 'flex';
        $('#user-avatar').textContent = currentUser.name.substring(0, 2).toUpperCase();
        $('#user-name').textContent = currentUser.name;
        $('#user-permission').textContent = currentUser.permission;
        $('#user-permission').className = `permission-badge permission-${currentUser.permission}`;
        
        // Mostrar controles de admin si es administrador
        if (currentUser.permission === 'admin') {
          adminControls.style.display = 'flex';
          $('#toggle-login-btn').textContent = SECURITY_CONFIG.showLoginButton ? 
            'üëÅÔ∏è Ocultar Login' : 'üëÅÔ∏è Mostrar Login';
        } else {
          adminControls.style.display = 'none';
        }
        
        // Bot√≥n de gesti√≥n para creadores
        if (currentUser.isCreator) {
          ownerToggle.style.display = 'flex';
          ownerToggle.classList.remove('locked');
          ownerToggle.dataset.state = drawerOpen ? 'open' : 'ready';
          $('#owner-toggle-label').textContent = drawerOpen ? 'Cerrar panel' : 'Gestionar recursos';
        } else {
          ownerToggle.style.display = 'none';
        }
        
        // Panel de gesti√≥n
        const canEdit = hasPermission('edit');
        drawer.classList.toggle('open', drawerOpen && canEdit);
        
        // Controles seg√∫n permisos
        $('#file').disabled = !hasPermission('upload');
        $('#shortcut-name').disabled = !hasPermission('edit');
        $('#shortcut-url').disabled = !hasPermission('edit');
        $('#shortcut-kind').disabled = !hasPermission('edit');
        $('#upload').disabled = !hasPermission('upload');
        $('#add-shortcut').disabled = !hasPermission('edit');
        $('#clear').disabled = !hasPermission('clear');
        
      } else {
        // Usuario no autenticado
        userInfo.style.display = 'none';
        adminControls.style.display = 'none';
        
        // Mostrar/ocultar bot√≥n de login seg√∫n preferencia
        if (shouldShowLoginButton()) {
          ownerToggle.style.display = 'flex';
          ownerToggle.classList.add('locked');
          ownerToggle.dataset.state = 'locked';
          $('#owner-toggle-label').textContent = 'Iniciar sesi√≥n';
        } else {
          ownerToggle.style.display = 'none';
        }
        
        // Ocultar panel de gesti√≥n
        drawer.classList.remove('open');
        
        // Deshabilitar controles
        $('#file').disabled = true;
        $('#shortcut-name').disabled = true;
        $('#shortcut-url').disabled = true;
        $('#shortcut-kind').disabled = true;
        $('#upload').disabled = true;
        $('#add-shortcut').disabled = true;
        $('#clear').disabled = true;
      }
      
      renderResources();
	  
	  updateEmergencyAccess();
    }

    function showAuthModal() {
      $('#auth-modal').classList.remove('hidden');
      $('#auth-username').focus();
    }
	
	// Atajo: Ctrl/‚åò + L abre el login si est√° oculto y no hay usuario
	window.addEventListener('keydown', (e) => {
	  const isCtrlOrMeta = e.ctrlKey || e.metaKey;
	  if (!currentUser && isCtrlOrMeta && (e.key || '').toLowerCase() === 'l') {
		e.preventDefault();
		showAuthModal();
	  }
	});

    function hideAuthModal() {
      $('#auth-modal').classList.add('hidden');
      $('#auth-error').style.display = 'none';
      $('#auth-username').value = '';
      $('#auth-password').value = '';
    }

    // Gesti√≥n de recursos
    function loadResources() {
      try {
        const encrypted = localStorage.getItem(storageKey);
        if (encrypted) {
          const decrypted = simpleDecrypt(encrypted, SECURITY_CONFIG.encryptionKey);
          if (decrypted) {
            const parsed = JSON.parse(decrypted);
            Object.assign(state, parsed);
            
            if (!Array.isArray(state.resources) && Array.isArray(parsed.images)) {
              state.resources = parsed.images.map((src, index) => ({
                type: 'shortcut',
                name: friendlyName(src) || 'Imagen ' + (index + 1),
                url: src,
                kind: 'enlace',
                legacy: true
              }));
            }
          }
        }
      } catch (e) {
        console.error("Error loading resources:", e);
      }
      
      if (!Array.isArray(state.resources)) state.resources = [];
    }

    function saveResources() {
      const encrypted = simpleEncrypt(JSON.stringify(state), SECURITY_CONFIG.encryptionKey);
      localStorage.setItem(storageKey, encrypted);
    }

    // Archivos se abren en nueva pesta√±a (como ClickUp Resources)
    function renderResources() {
      const list = $('#list');
      list.innerHTML = '';
      
      // Todos pueden ver los recursos
      const canView = true;
      
      if (!canView) {
        $('#empty').textContent = 'Inicia sesi√≥n para ver los recursos';
        $('#empty').classList.remove('hidden');
        return;
      }
      
      if (!state.resources.length) {
        $('#empty').textContent = 'A√±ade archivos o accesos para que todo tu equipo pueda consultarlos aqu√≠.';
        $('#empty').classList.remove('hidden');
        return;
      }
      
      $('#empty').classList.add('hidden');

      state.resources.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'resource';
        li.draggable = hasPermission('edit');
        li.dataset.index = idx;

        const link = document.createElement('a');
        link.draggable = false;
        
        // Comportamiento como ClickUp Resources
        if (item.type === 'file') {
          link.href = item.data;
          link.target = '_blank'; // Abre en nueva pesta√±a
          link.rel = 'noopener';
        } else {
          link.href = item.url;
          link.target = '_blank';
          link.rel = 'noopener';
        }

        const badge = document.createElement('span');
        badge.className = 'badge';
        if (item.type === 'file') {
          badge.textContent = fileLabel(item.name);
        } else {
          const label = (item.kind || 'enlace').toString().trim().toUpperCase();
          badge.textContent = label.length > 6 ? label.slice(0, 6) : label || 'LINK';
        }

        const meta = document.createElement('div');
        meta.className = 'meta';
        const primary = document.createElement('span');
        primary.className = 'primary-text';
        primary.textContent = item.name;
        const secondary = document.createElement('span');
        secondary.className = 'secondary-text';
        secondary.textContent = item.type === 'file' ? formatBytes(item.size) : compactUrl(item.url);
        meta.appendChild(primary);
        meta.appendChild(secondary);

        const avatar = document.createElement('span');
        avatar.className = 'avatar';
        avatar.textContent = avatarText(item);

        link.appendChild(badge);
        link.appendChild(meta);
        link.appendChild(avatar);
        li.appendChild(link);

        if (hasPermission('edit')) {
          const ownerBar = document.createElement('div');
          ownerBar.className = 'owner-actions';

          const drag = document.createElement('button');
          drag.className = 'tiny-btn';
          drag.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 4h4m-4 6h4m-4 6h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          drag.title = 'Mover';
          drag.addEventListener('click', e => e.preventDefault());

          const del = document.createElement('button');
          del.className = 'tiny-btn';
          del.title = 'Eliminar';
          del.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="m6 6 12 12M6 18 18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          del.onclick = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            state.resources.splice(idx, 1);
            saveResources();
            renderResources();
          };

          ownerBar.appendChild(drag);
          ownerBar.appendChild(del);
          li.appendChild(ownerBar);

          // Funcionalidad de arrastrar y soltar
          li.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', idx.toString());
            e.dataTransfer.effectAllowed = 'move';
            requestAnimationFrame(() => li.classList.add('dragging'));
          });
          li.addEventListener('dragend', () => {
            li.classList.remove('dragging');
          });
          li.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
          });
          li.addEventListener('drop', e => {
            e.preventDefault();
            const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
            if (Number.isNaN(from)) return;
            const rect = li.getBoundingClientRect();
            const after = (e.clientY - rect.top) > rect.height / 2;
            let target = idx + (after ? 1 : 0);
            const [m] = state.resources.splice(from, 1);
            if (from < target) target -= 1;
            if (target < 0) target = 0;
            if (target > state.resources.length) target = state.resources.length;
            state.resources.splice(target, 0, m);
            saveResources();
            renderResources();
          });
        }

        list.appendChild(li);
      });
    }

    function handleFiles(list) {
      if (!hasPermission('upload')) {
        alert('No tienes permisos para subir archivos');
        return;
      }
      
      const files = Array.from(list || []);
      if (!files.length) return;
      
      Promise.all(files.map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
          type: 'file',
          name: file.name,
          size: file.size,
          data: reader.result,
          addedAt: Date.now(),
          addedBy: currentUser.username
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
      }))).then(results => {
        state.resources.push(...results);
        saveResources();
        renderResources();
        $('#file').value = '';
      }).catch(() => {
        alert('No se pudo leer uno de los archivos seleccionados.');
      });
    }

    // Utilidades
    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return '';
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = bytes === 0 ? 0 : Math.floor(Math.log(bytes) / Math.log(1024));
      const v = bytes / Math.pow(1024, i);
      return v.toFixed(v >= 10 || i === 0 ? 0 : 1) + ' ' + sizes[i];
    }

    function friendlyName(url) {
      try {
        const u = new URL(url);
        const segments = u.pathname.split('/').filter(Boolean).map(s => decodeURIComponent(s.replace(/[-_]+/g, ' ')));
        if (segments.length) return capitalizeWords(segments[segments.length - 1]);
        return u.hostname.replace(/^www\./, '');
      } catch (e) {
        return '';
      }
    }

    function compactUrl(url) {
      try {
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./, '');
        const segments = u.pathname.split('/').filter(Boolean).slice(-2).map(s => decodeURIComponent(s.replace(/[-_]+/g, ' ')));
        const path = segments.join(' ‚Ä∫ ');
        return path ? host + ' ¬∑ ' + capitalizeWords(path) : host;
      } catch (e) {
        return url;
      }
    }

    function capitalizeWords(str) {
      return str.replace(/\b\w+/g, txt => txt.charAt(0).toUpperCase() + txt.slice(1));
    }

    function fileLabel(name) {
      const ext = (name.split('.').pop() || '').toLowerCase();
      if (!ext) return 'FILE';
      return ext.slice(0, 4).toUpperCase();
    }

    function avatarText(item) {
      const base = item.type === 'file' ? (item.name || '') : (item.name || item.url || '');
      const sanitized = base.replace(/\.[a-z0-9]{2,6}$/i, '');
      const words = sanitized.split(/[\s_\-\/]+/).filter(Boolean).filter(word => /[\p{L}\p{N}]/u.test(word));
      if (!words.length) return '‚Ä¢';
      const initials = words.length >= 2 ? (words[0][0] + words[1][0]) : words[0].slice(0, 2);
      return initials.toUpperCase();
    }

    function getCardDisplayName() {
      return cardNames[cardKey] || `la tarjeta "${cardKey}"`;
    }

    // Event listeners
    $('#owner-toggle').addEventListener('click', () => {
      if (currentUser) {
        drawerOpen = !drawerOpen;
        updateUI();
      } else {
        if (shouldShowLoginButton()) {
          showAuthModal();
        }
      }
    });

    $('#logout-btn').addEventListener('click', () => {
      endSession();
    });

    $('#toggle-login-btn').addEventListener('click', () => {
      toggleLoginVisibility();
    });

    $('#auth-submit').addEventListener('click', () => {
      const username = $('#auth-username').value.trim();
      const password = $('#auth-password').value;
      
      if (!username || !password) {
        $('#auth-error').textContent = 'Completa todos los campos';
        $('#auth-error').style.display = 'block';
        return;
      }
      
      const authResult = authenticate(username, password);
      if (authResult.success) {
        startSession(authResult.user);
        hideAuthModal();
      } else {
        $('#auth-error').textContent = authResult.error;
        $('#auth-error').style.display = 'block';
      }
    });

    $('#auth-modal').addEventListener('click', (e) => {
      if (e.target === $('#auth-modal')) {
        hideAuthModal();
      }
    });

    $('#auth-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        $('#auth-submit').click();
      }
    });

    $('#upload').addEventListener('click', () => {
      if (!hasPermission('upload')) {
        alert('No tienes permisos para subir archivos');
        return;
      }
      const input = $('#file');
      if (!input.files.length) {
        input.click();
        return;
      }
      handleFiles(input.files);
    });

    $('#file').addEventListener('change', e => {
      if (!hasPermission('upload')) return;
      handleFiles(e.target.files);
    });

    $('#add-shortcut').addEventListener('click', () => {
      if (!hasPermission('edit')) {
        alert('No tienes permisos para a√±adir accesos');
        return;
      }
      const name = $('#shortcut-name').value.trim();
      const url = $('#shortcut-url').value.trim();
      const kind = ($('#shortcut-kind').value || 'link').toLowerCase();
      if (!name || !url) return;
      state.resources.push({ 
        type: 'shortcut', 
        name, 
        url, 
        kind, 
        addedAt: Date.now(),
        addedBy: currentUser.username
      });
      $('#shortcut-name').value = '';
      $('#shortcut-url').value = '';
      $('#shortcut-kind').value = 'lista';
      saveResources();
      renderResources();
    });

    $('#clear').addEventListener('click', () => {
      if (!hasPermission('clear')) {
        alert('No tienes permisos para vaciar todos los recursos');
        return;
      }
      
      const cardDisplayName = getCardDisplayName();
      if (confirm(`¬øVaciar todos los recursos de ${cardDisplayName}?`)) {
        state.resources = [];
        saveResources();
        renderResources();
      }
    });

    const card = $('#card');
    card.addEventListener('dragover', e => {
      if (e.dataTransfer && (e.dataTransfer.files.length || e.dataTransfer.types.includes('text/uri-list'))) {
        e.preventDefault();
      }
    });
    
    card.addEventListener('drop', e => {
      if (!e.dataTransfer) return;
      e.preventDefault();
      
      if (!hasPermission('upload') && !hasPermission('edit')) {
        alert('No tienes permisos para a√±adir recursos');
        return;
      }
      
      if (e.dataTransfer.files.length) {
        if (!hasPermission('upload')) {
          alert('No tienes permisos para subir archivos');
          return;
        }
        handleFiles(e.dataTransfer.files);
      } else {
        if (!hasPermission('edit')) {
          alert('No tienes permisos para a√±adir enlaces');
          return;
        }
        const text = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
        if (text && /^https?:\/\//i.test(text.trim())) {
          const link = text.trim();
          state.resources.push({ 
            type: 'shortcut', 
            name: friendlyName(link) || link, 
            url: link, 
            kind: 'enlace', 
            addedAt: Date.now(),
            addedBy: currentUser.username
          });
          saveResources();
          renderResources();
        }
      }
    });

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      // Crear el acceso de emergencia al cargar la p√°gina
      createEmergencyAccess();
	  
	  // Forzar modal de login por URL: ?...&unlock=1
	if (params.get('unlock') === '1' && !currentUser) {
	  showAuthModal();
	}

      
      loadResources();
      
      if (checkSession()) {
        updateUI();
      } else {
        if (SECURITY_CONFIG.requireAuthForView) {
          if (shouldShowLoginButton()) {
            showAuthModal();
          }
        } else {
          updateUI();
        }
      }
    });
  </script>
</body>

</html>