<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tarjeta de Recursos</title>
  <style>
    :root {
      --radius: 14px;
      --pad: 16px;
      --gap: 6px;
      --muted: rgba(255,255,255,0.55);
      --surface: var(--cu-panel-color, transparent);
      --surface-border: var(--cu-panel-border, rgba(148,163,184,0.22));
      --surface-backdrop: var(--cu-panel-backdrop, saturate(160%) blur(18px));
      --text: var(--cu-text-color, #f1f5f9);
      --accent: var(--cu-accent-color, #9da7ff);
      --badge-bg: rgba(255,255,255,0.08);
      --badge-text: rgba(255,255,255,0.7);
      --avatar-bg: rgba(255,255,255,0.12);
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    html,
    body {
      margin: 0;
    }
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      background: transparent;
      color: var(--text);
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      font-size: 13px;
      line-height: 1.5;
    }
    .card {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: var(--pad);
      border-radius: var(--radius);
      background-color: var(--surface, transparent);
      border: 1px solid rgba(148,163,184,0.18);
      border-color: var(--surface-border);
      backdrop-filter: var(--surface-backdrop);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    h1 {
      font-size: 15px;
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .owner-tools {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .icon-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(15,23,42,0.3);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .icon-btn:hover {
      background: rgba(255,255,255,0.08);
    }
    .panel {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.07);
      background: rgba(15,23,42,0.55);
      padding: 14px;
      display: grid;
      gap: 14px;
    }
    .panel-row {
      display: grid;
      gap: 8px;
    }
    .panel label {
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.5px;
      color: var(--muted);
    }
    .panel input,
    .panel select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(15,23,42,0.65);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }
    .panel-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .panel-actions button {
      flex: 1 1 auto;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(148,163,184,0.08);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }
    .panel-actions button.primary {
      background: linear-gradient(130deg, rgba(124,147,255,0.9), rgba(151,173,255,0.75));
      color: #0b1220;
      border-color: transparent;
    }
    .panel-actions button.danger {
      color: #fda4af;
      background: rgba(239,68,68,0.1);
      border-color: rgba(239,68,68,0.18);
    }
    .drawer {
      display: none;
      flex-direction: column;
      gap: 12px;
    }
    .drawer.open {
      display: flex;
    }
    .muted {
      color: var(--muted);
      font-size: 12px;
    }
    #empty {
      padding: 12px 0 4px;
    }
    ul.resources {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .resource {
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 10px;
      padding: 6px 8px;
      transition: background 0.15s ease;
    }
    .resource:hover {
      background: rgba(255,255,255,0.05);
    }
    .resource.dragging {
      opacity: 0.45;
    }
    .resource a {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
      min-width: 0;
    }
    .badge {
      min-width: 36px;
      padding: 4px 6px;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-size: 10px;
      text-align: center;
      background: var(--badge-bg);
      color: var(--badge-text);
      font-weight: 600;
    }
    .primary-text {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
    }
    .secondary-text {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1 1 auto;
      min-width: 0;
    }
    .avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: rgba(255,255,255,0.85);
      background: var(--avatar-bg);
    }
    .owner-actions {
      display: flex;
      gap: 4px;
    }
    .tiny-btn {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(15,23,42,0.4);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .tiny-btn:hover {
      background: rgba(255,255,255,0.08);
    }
    .hidden {
      display: none !important;
    }
    @media (max-width: 480px) {
      body {
        font-size: 12px;
      }
      h1 {
        font-size: 14px;
      }
      .card {
        padding: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <header>
      <h1 id="title">Recursos</h1>
      <div class="owner-tools hidden" id="owner-tools">
        <button class="icon-btn" id="toggle-drawer" title="Abrir panel de edición">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </header>

    <div class="drawer" id="drawer">
      <div class="panel">
        <div class="panel-row">
          <label for="file">Subir archivo</label>
          <input id="file" type="file" multiple />
          <div class="panel-actions">
            <button class="primary" id="upload">Añadir archivo</button>
          </div>
        </div>
        <div class="panel-row">
          <label for="shortcut-name">Nuevo acceso</label>
          <input id="shortcut-name" type="text" placeholder="Ej. Manual de marca" />
          <input id="shortcut-url" type="url" placeholder="https://app.clickup.com/..." />
          <select id="shortcut-kind">
            <option value="lista">Lista</option>
            <option value="carpeta">Carpeta</option>
            <option value="documento">Documento</option>
            <option value="otro">Otro</option>
          </select>
          <div class="panel-actions">
            <button id="add-shortcut">Guardar acceso</button>
          </div>
        </div>
        <div class="panel-actions">
          <button class="danger" id="clear">Vaciar todo</button>
        </div>
      </div>
    </div>

    <div id="empty" class="muted">Añade archivos o accesos para que todo tu equipo pueda consultarlos aquí.</div>
    <ul class="resources" id="list"></ul>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const storageKey = 'clickup_resources_card:' + (params.get('key') || location.pathname);
    const state = { resources: [] };

    const $ = (q) => document.querySelector(q);
    const ownerMode = (params.get('owner') === '1') || (params.get('edit') === '1');
    const viewOnly = !ownerMode;

    function load() {
      try {
        const raw = localStorage.getItem(storageKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          Object.assign(state, parsed);
          if (!Array.isArray(state.resources) && Array.isArray(parsed.images)) {
            state.resources = parsed.images.map((src, index) => ({
              type: 'shortcut',
              name: friendlyName(src) || 'Imagen ' + (index + 1),
              url: src,
              kind: 'enlace',
              legacy: true
            }));
          }
        }
      } catch (e) {}
      if (!Array.isArray(state.resources)) state.resources = [];
      renderAll();
    }
    function save() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function renderAll() {
      $('#title').textContent = decodeURIComponent(params.get('title') || 'Recursos');
      $('#owner-tools').classList.toggle('hidden', viewOnly);
      $('#drawer').classList.toggle('open', ownerMode && drawerOpen);

      const list = $('#list');
      list.innerHTML = '';
      if (!state.resources.length) {
        $('#empty').classList.remove('hidden');
        return;
      }
      $('#empty').classList.add('hidden');

      state.resources.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'resource';
        li.draggable = ownerMode;
        li.dataset.index = idx;

        const link = document.createElement('a');
        link.draggable = false;
        if (item.type === 'file') {
          link.href = item.data;
          link.download = item.name;
        } else {
          link.href = item.url;
          link.target = '_blank';
          link.rel = 'noopener';
        }

        const badge = document.createElement('span');
        badge.className = 'badge';
        if (item.type === 'file') {
          badge.textContent = fileLabel(item.name);
        } else {
          const label = (item.kind || 'enlace').toString().trim().toUpperCase();
          badge.textContent = label.length > 6 ? label.slice(0, 6) : label || 'LINK';
        }

        const meta = document.createElement('div');
        meta.className = 'meta';
        const primary = document.createElement('span');
        primary.className = 'primary-text';
        primary.textContent = item.name;
        const secondary = document.createElement('span');
        secondary.className = 'secondary-text';
        secondary.textContent = item.type === 'file' ? formatBytes(item.size) : compactUrl(item.url);
        meta.appendChild(primary);
        meta.appendChild(secondary);

        const avatar = document.createElement('span');
        avatar.className = 'avatar';
        avatar.textContent = avatarText(item);

        link.appendChild(badge);
        link.appendChild(meta);
        link.appendChild(avatar);
        li.appendChild(link);

        if (ownerMode) {
          const ownerBar = document.createElement('div');
          ownerBar.className = 'owner-actions';

          const drag = document.createElement('button');
          drag.className = 'tiny-btn';
          drag.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 4h4m-4 6h4m-4 6h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          drag.title = 'Mover';
          drag.addEventListener('click', e => e.preventDefault());

          const del = document.createElement('button');
          del.className = 'tiny-btn';
          del.title = 'Eliminar';
          del.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="m6 6 12 12M6 18 18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          del.onclick = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            state.resources.splice(idx, 1);
            save();
            renderAll();
          };

          ownerBar.appendChild(drag);
          ownerBar.appendChild(del);
          li.appendChild(ownerBar);
        }

        if (ownerMode) {
          li.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', idx.toString());
            e.dataTransfer.effectAllowed = 'move';
            requestAnimationFrame(() => li.classList.add('dragging'));
          });
          li.addEventListener('dragend', () => {
            li.classList.remove('dragging');
          });
          li.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
          });
          li.addEventListener('drop', e => {
            e.preventDefault();
            const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
            if (Number.isNaN(from)) return;
            const rect = li.getBoundingClientRect();
            const after = (e.clientY - rect.top) > rect.height / 2;
            let target = idx + (after ? 1 : 0);
            const [m] = state.resources.splice(from, 1);
            if (from < target) target -= 1;
            if (target < 0) target = 0;
            if (target > state.resources.length) target = state.resources.length;
            state.resources.splice(target, 0, m);
            save();
            renderAll();
          });
        }

        list.appendChild(li);
      });
    }

    function handleFiles(list) {
      const files = Array.from(list || []);
      if (!files.length) return;
      Promise.all(files.map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
          type: 'file',
          name: file.name,
          size: file.size,
          data: reader.result,
          addedAt: Date.now()
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
      })) ).then(results => {
        state.resources.push(...results);
        save();
        renderAll();
        $('#file').value = '';
      }).catch(() => {
        alert('No se pudo leer uno de los archivos seleccionados.');
      });
    }


    if (!viewOnly) {
      $('#upload').onclick = () => {
        const input = $('#file');
        if (!input.files.length) {
          input.click();
          return;
        }
        handleFiles(input.files);
      };

      $('#file').addEventListener('change', e => {
        handleFiles(e.target.files);
      });

      $('#add-shortcut').onclick = () => {
        const name = $('#shortcut-name').value.trim();
        const url = $('#shortcut-url').value.trim();
        const kind = ($('#shortcut-kind').value || 'link').toLowerCase();
        if (!name || !url) return;
        state.resources.push({ type: 'shortcut', name, url, kind, addedAt: Date.now() });
        $('#shortcut-name').value = '';
        $('#shortcut-url').value = '';
        $('#shortcut-kind').value = 'lista';
        save();
        renderAll();
      };

      $('#clear').onclick = () => {
        if (confirm('¿Vaciar todos los recursos?')) {
          state.resources = [];
          save();
          renderAll();
        }
      };

      $('#toggle-drawer').addEventListener('click', () => {
        drawerOpen = !drawerOpen;
        renderAll();
      });
    }

    const card = $('#card');
    card.addEventListener('dragover', e => {
      if (e.dataTransfer && (e.dataTransfer.files.length || e.dataTransfer.types.includes('text/uri-list'))) {
        e.preventDefault();
      }
    });
    card.addEventListener('drop', e => {
      if (!e.dataTransfer) return;
      e.preventDefault();
      if (!viewOnly && e.dataTransfer.files.length) {
        handleFiles(e.dataTransfer.files);
      } else if (!viewOnly) {
        const text = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
        if (text && /^https?:\/\//i.test(text.trim())) {
          const link = text.trim();
          state.resources.push({ type: 'shortcut', name: friendlyName(link) || link, url: link, kind: 'enlace', addedAt: Date.now() });
          save();
          renderAll();
        }
      }
    });
    window.addEventListener('paste', e => {
      const text = (e.clipboardData || window.clipboardData).getData('text');
      if (!viewOnly && text && /^https?:\/\//i.test(text.trim())) {
        const link = text.trim();
        state.resources.push({ type: 'shortcut', name: friendlyName(link) || link, url: link, kind: 'enlace', addedAt: Date.now() });
        save();
        renderAll();
      }
    });

    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return '';
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = bytes === 0 ? 0 : Math.floor(Math.log(bytes) / Math.log(1024));
      const v = bytes / Math.pow(1024, i);
      return v.toFixed(v >= 10 || i === 0 ? 0 : 1) + ' ' + sizes[i];
    }

    function friendlyName(url) {
      try {
        const u = new URL(url);
        const segments = u.pathname.split('/').filter(Boolean).map(s => decodeURIComponent(s.replace(/[-_]+/g, ' ')));
        if (segments.length) return capitalizeWords(segments[segments.length - 1]);
        return u.hostname.replace(/^www\./, '');
      } catch (e) {
        return '';
      }
    }

    function compactUrl(url) {
      try {
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./, '');
        const segments = u.pathname.split('/').filter(Boolean).slice(-2).map(s => decodeURIComponent(s.replace(/[-_]+/g, ' ')));
        const path = segments.join(' › ');
        return path ? host + ' · ' + capitalizeWords(path) : host;
      } catch (e) {
        return url;
      }
    }

    function capitalizeWords(str) {
      return str.replace(/\b\w+/g, txt => txt.charAt(0).toUpperCase() + txt.slice(1));
    }

    function fileLabel(name) {
      const ext = (name.split('.').pop() || '').toLowerCase();
      if (!ext) return 'FILE';
      return ext.slice(0, 4).toUpperCase();
    }

    function avatarText(item) {
      const base = item.type === 'file' ? (item.name || '') : (item.name || item.url || '');
      const sanitized = base.replace(/\.[a-z0-9]{2,6}$/i, '');
      const words = sanitized.split(/[\s_\-\/]+/).filter(Boolean).filter(word => /[\p{L}\p{N}]/u.test(word));
      if (!words.length) return '•';
      const initials = words.length >= 2 ? (words[0][0] + words[1][0]) : words[0].slice(0, 2);
      return initials.toUpperCase();
    }

    let drawerOpen = ownerMode;

    load();
  </script>
</body>
</html>

