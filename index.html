<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tarjeta de Recursos</title>
  <style>
    :root {
      --pad: 12px;
      --muted: rgba(226, 232, 240, 0.64);
      --text: var(--cu-text-color, #e2e8f0);
      --accent: var(--cu-accent-color, #94a3ff);
      --row-hover: rgba(148, 163, 184, 0.14);
      --row-border: rgba(148, 163, 184, 0.18);
      --badge-bg: rgba(148, 163, 184, 0.16);
      --badge-text: rgba(226, 232, 240, 0.78);
      --avatar-bg: rgba(148, 163, 184, 0.25);
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    html,
    body {
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      font-size: 13px;
      line-height: 1.5;
      background: transparent;
      color: var(--text);
      display: flex;
      width: 100%;
      min-height: 100%;
    }
    .card {
      width: 100%;
      flex: 1 1 auto;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: var(--pad) 0;
    }
    .owner-bar {
      display: flex;
      justify-content: flex-end;
      padding: 0 var(--pad);
    }
    .ghost-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: rgba(148, 163, 184, 0.12);
      color: inherit;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .ghost-btn.locked {
      background: rgba(148, 163, 184, 0.08);
    }
    .ghost-btn[data-state='ready'] {
      background: rgba(148, 163, 184, 0.18);
      border-color: rgba(148, 163, 184, 0.24);
    }
    .ghost-btn[data-state='open'] {
      background: rgba(148, 163, 184, 0.28);
      border-color: rgba(148, 163, 184, 0.3);
    }
    .ghost-btn:hover {
      background: rgba(148, 163, 184, 0.2);
      border-color: rgba(148, 163, 184, 0.22);
    }
    .ghost-btn svg {
      opacity: 0.85;
    }
    .drawer {
      margin: 0 var(--pad);
      display: none;
      flex-direction: column;
      gap: 14px;
      padding: 14px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.34);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }
    .drawer.open {
      display: flex;
    }
    .drawer h2 {
      margin: 0;
      font-size: 12px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .form-group {
      display: grid;
      gap: 8px;
    }
    .form-group label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted);
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      font-size: 13px;
      outline: none;
    }
    .form-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .form-actions button {
      flex: 1 1 auto;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(148, 163, 184, 0.16);
      color: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .form-actions button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .form-actions button.primary {
      background: linear-gradient(135deg, rgba(148, 163, 255, 0.95), rgba(118, 134, 255, 0.8));
      border-color: transparent;
      color: #0b1220;
    }
    .form-actions button.danger {
      color: #fecdd3;
      background: rgba(239, 68, 68, 0.18);
      border-color: rgba(239, 68, 68, 0.24);
    }
    .muted {
      color: var(--muted);
      font-size: 12px;
    }
    #empty {
      padding: 12px var(--pad) 0;
    }
    ul.resources {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .resource {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px var(--pad);
      border-bottom: 1px solid transparent;
      border-radius: 10px;
      transition: background 0.15s ease;
    }
    .resource + .resource {
      border-top: 1px solid rgba(148, 163, 184, 0.06);
    }
    .resource:hover {
      background: var(--row-hover);
    }
    .resource.dragging {
      opacity: 0.45;
    }
    .resource a {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
      min-width: 0;
    }
    .badge {
      min-width: 36px;
      padding: 4px 6px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 10px;
      text-align: center;
      background: var(--badge-bg);
      color: var(--badge-text);
      font-weight: 600;
    }
    .primary-text {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
    }
    .secondary-text {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1 1 auto;
      min-width: 0;
    }
    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: rgba(15, 23, 42, 0.86);
      background: var(--avatar-bg);
    }
    .owner-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    .tiny-btn {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(15, 23, 42, 0.4);
      color: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .tiny-btn:hover {
      background: rgba(148, 163, 184, 0.28);
    }
    .tiny-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .hidden {
      display: none !important;
    }
    @media (max-width: 480px) {
      body {
        font-size: 12px;
      }
      .card {
        gap: 10px;
      }
      .ghost-btn {
        font-size: 11px;
        padding: 5px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="owner-bar" id="owner-bar">
      <button class="ghost-btn locked" id="owner-toggle" type="button">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 11H7a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-7a1 1 0 0 0-1-1ZM15 11V8a3 3 0 1 0-6 0v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span id="owner-toggle-label">Gestionar recursos</span>
      </button>
    </div>

    <div class="drawer" id="drawer" aria-hidden="true">
      <div class="form-group">
        <h2>Archivos</h2>
        <input id="file" type="file" multiple />
        <div class="form-actions">
          <button class="primary" id="upload" type="button">Subir archivos</button>
        </div>
      </div>
      <div class="form-group">
        <h2>Accesos directos</h2>
        <label for="shortcut-name">Nombre</label>
        <input id="shortcut-name" type="text" placeholder="Ej. Manual de marca" />
        <label for="shortcut-url">URL</label>
        <input id="shortcut-url" type="url" placeholder="https://app.clickup.com/..." />
        <label for="shortcut-kind">Tipo</label>
        <select id="shortcut-kind">
          <option value="lista">Lista</option>
          <option value="carpeta">Carpeta</option>
          <option value="documento">Documento</option>
          <option value="otro">Otro</option>
        </select>
        <div class="form-actions">
          <button id="add-shortcut" type="button">Guardar acceso</button>
          <button class="danger" id="clear" type="button">Vaciar todo</button>
        </div>
      </div>
    </div>

    <div id="empty" class="muted">Añade archivos o accesos para que todo tu equipo pueda consultarlos aquí.</div>
    <ul class="resources" id="list"></ul>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const storageKey = 'clickup_resources_card:' + (params.get('key') || location.pathname);
    const ownerStorageKey = storageKey + ':ownerUnlock';
    const ownerKey = (params.get('ownerKey') || '').trim();
    const state = { resources: [] };

    const $ = (q) => document.querySelector(q);

    let ownerMode = (params.get('owner') === '1') || (params.get('edit') === '1');
    const storedUnlock = localStorage.getItem(ownerStorageKey);
    if (!ownerMode && storedUnlock) {
      if (!ownerKey || storedUnlock === ownerKey) {
        ownerMode = true;
      }
    } else if (ownerMode) {
      localStorage.setItem(ownerStorageKey, ownerKey || '1');
    }

    function load() {
      try {
        const raw = localStorage.getItem(storageKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          Object.assign(state, parsed);
          if (!Array.isArray(state.resources) && Array.isArray(parsed.images)) {
            state.resources = parsed.images.map((src, index) => ({
              type: 'shortcut',
              name: friendlyName(src) || 'Imagen ' + (index + 1),
              url: src,
              kind: 'enlace',
              legacy: true
            }));
          }
        }
      } catch (e) {}
      if (!Array.isArray(state.resources)) state.resources = [];
      renderAll();
    }
    function save() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function renderAll() {
      const toggle = $('#owner-toggle');
      const toggleLabel = $('#owner-toggle-label');
      toggle.classList.toggle('locked', !ownerMode);
      toggleLabel.textContent = ownerMode
        ? (drawerOpen ? 'Cerrar panel' : 'Gestionar recursos')
        : 'Desbloquear gestión';
      toggle.setAttribute('aria-pressed', ownerMode && drawerOpen ? 'true' : 'false');
      toggle.setAttribute('aria-label', ownerMode
        ? (drawerOpen ? 'Cerrar panel de gestión' : 'Abrir panel de gestión')
        : 'Desbloquear panel de gestión');
      const drawer = $('#drawer');
      const drawerOpenState = ownerMode && drawerOpen;
      toggle.dataset.state = ownerMode ? (drawerOpenState ? 'open' : 'ready') : 'locked';
      toggle.setAttribute('aria-expanded', drawerOpenState ? 'true' : 'false');
      drawer.classList.toggle('open', drawerOpenState);
      drawer.setAttribute('aria-hidden', drawerOpenState ? 'false' : 'true');

      $('#file').disabled = !ownerMode;
      $('#shortcut-name').disabled = !ownerMode;
      $('#shortcut-url').disabled = !ownerMode;
      $('#shortcut-kind').disabled = !ownerMode;
      $('#upload').disabled = !ownerMode;
      $('#add-shortcut').disabled = !ownerMode;
      $('#clear').disabled = !ownerMode;

      const list = $('#list');
      list.innerHTML = '';
      if (!state.resources.length) {
        $('#empty').classList.remove('hidden');
        return;
      }
      $('#empty').classList.add('hidden');

      state.resources.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'resource';
        li.draggable = ownerMode;
        li.dataset.index = idx;

        const link = document.createElement('a');
        link.draggable = false;
        if (item.type === 'file') {
          link.href = item.data;
          link.download = item.name;
        } else {
          link.href = item.url;
          link.target = '_blank';
          link.rel = 'noopener';
        }

        const badge = document.createElement('span');
        badge.className = 'badge';
        if (item.type === 'file') {
          badge.textContent = fileLabel(item.name);
        } else {
          const label = (item.kind || 'enlace').toString().trim().toUpperCase();
          badge.textContent = label.length > 6 ? label.slice(0, 6) : label || 'LINK';
        }

        const meta = document.createElement('div');
        meta.className = 'meta';
        const primary = document.createElement('span');
        primary.className = 'primary-text';
        primary.textContent = item.name;
        const secondary = document.createElement('span');
        secondary.className = 'secondary-text';
        secondary.textContent = item.type === 'file' ? formatBytes(item.size) : compactUrl(item.url);
        meta.appendChild(primary);
        meta.appendChild(secondary);

        const avatar = document.createElement('span');
        avatar.className = 'avatar';
        avatar.textContent = avatarText(item);

        link.appendChild(badge);
        link.appendChild(meta);
        link.appendChild(avatar);
        li.appendChild(link);

        if (ownerMode) {
          const ownerBar = document.createElement('div');
          ownerBar.className = 'owner-actions';

          const drag = document.createElement('button');
          drag.className = 'tiny-btn';
          drag.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 4h4m-4 6h4m-4 6h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          drag.title = 'Mover';
          drag.addEventListener('click', e => e.preventDefault());

          const del = document.createElement('button');
          del.className = 'tiny-btn';
          del.title = 'Eliminar';
          del.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="m6 6 12 12M6 18 18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          del.onclick = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            state.resources.splice(idx, 1);
            save();
            renderAll();
          };

          ownerBar.appendChild(drag);
          ownerBar.appendChild(del);
          li.appendChild(ownerBar);
        }

        if (ownerMode) {
          li.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', idx.toString());
            e.dataTransfer.effectAllowed = 'move';
            requestAnimationFrame(() => li.classList.add('dragging'));
          });
          li.addEventListener('dragend', () => {
            li.classList.remove('dragging');
          });
          li.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
          });
          li.addEventListener('drop', e => {
            e.preventDefault();
            const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
            if (Number.isNaN(from)) return;
            const rect = li.getBoundingClientRect();
            const after = (e.clientY - rect.top) > rect.height / 2;
            let target = idx + (after ? 1 : 0);
            const [m] = state.resources.splice(from, 1);
            if (from < target) target -= 1;
            if (target < 0) target = 0;
            if (target > state.resources.length) target = state.resources.length;
            state.resources.splice(target, 0, m);
            save();
            renderAll();
          });
        }

        list.appendChild(li);
      });
    }

    function handleFiles(list) {
      const files = Array.from(list || []);
      if (!files.length) return;
      Promise.all(files.map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
          type: 'file',
          name: file.name,
          size: file.size,
          data: reader.result,
          addedAt: Date.now()
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
      })) ).then(results => {
        state.resources.push(...results);
        save();
        renderAll();
        $('#file').value = '';
      }).catch(() => {
        alert('No se pudo leer uno de los archivos seleccionados.');
      });
    }

    function attemptOwnerUnlock(forceOpen = false) {
      if (ownerMode) return true;
      if (ownerKey) {
        const attempt = prompt('Introduce la clave de edición para gestionar los recursos:');
        if (attempt === null) return false;
        if (attempt === ownerKey) {
          ownerMode = true;
          drawerOpen = forceOpen ? true : drawerOpen;
          localStorage.setItem(ownerStorageKey, ownerKey);
          renderAll();
          return true;
        }
        alert('Clave incorrecta.');
        return false;
      }
      ownerMode = true;
      drawerOpen = forceOpen ? true : drawerOpen;
      localStorage.setItem(ownerStorageKey, '1');
      renderAll();
      return true;
    }

    $('#upload').addEventListener('click', () => {
      if (!ownerMode && !attemptOwnerUnlock(true)) {
        return;
      }
      const input = $('#file');
      if (!input.files.length) {
        input.click();
        return;
      }
      handleFiles(input.files);
    });

    $('#file').addEventListener('change', e => {
      if (!ownerMode) return;
      handleFiles(e.target.files);
    });

    $('#add-shortcut').addEventListener('click', () => {
      if (!ownerMode && !attemptOwnerUnlock(true)) {
        return;
      }
      const name = $('#shortcut-name').value.trim();
      const url = $('#shortcut-url').value.trim();
      const kind = ($('#shortcut-kind').value || 'link').toLowerCase();
      if (!name || !url) return;
      state.resources.push({ type: 'shortcut', name, url, kind, addedAt: Date.now() });
      $('#shortcut-name').value = '';
      $('#shortcut-url').value = '';
      $('#shortcut-kind').value = 'lista';
      save();
      renderAll();
    });

    $('#clear').addEventListener('click', () => {
      if (!ownerMode && !attemptOwnerUnlock(true)) {
        return;
      }
      if (confirm('¿Vaciar todos los recursos?')) {
        state.resources = [];
        save();
        renderAll();
      }
    });

    $('#owner-toggle').addEventListener('click', () => {
      if (ownerMode) {
        drawerOpen = !drawerOpen;
        renderAll();
        return;
      }
      attemptOwnerUnlock(true);
    });

    const card = $('#card');
    card.addEventListener('dragover', e => {
      if (e.dataTransfer && (e.dataTransfer.files.length || e.dataTransfer.types.includes('text/uri-list'))) {
        e.preventDefault();
      }
    });
    card.addEventListener('drop', e => {
      if (!e.dataTransfer) return;
      e.preventDefault();
      if (!ownerMode) {
        attemptOwnerUnlock(true);
        return;
      }
      if (e.dataTransfer.files.length) {
        handleFiles(e.dataTransfer.files);
      } else {
        const text = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
        if (text && /^https?:\/\//i.test(text.trim())) {
          const link = text.trim();
          state.resources.push({ type: 'shortcut', name: friendlyName(link) || link, url: link, kind: 'enlace', addedAt: Date.now() });
          save();
          renderAll();
        }
      }
    });
    window.addEventListener('paste', e => {
      const text = (e.clipboardData || window.clipboardData).getData('text');
      if (!ownerMode) return;
      if (text && /^https?:\/\//i.test(text.trim())) {
        const link = text.trim();
        state.resources.push({ type: 'shortcut', name: friendlyName(link) || link, url: link, kind: 'enlace', addedAt: Date.now() });
        save();
        renderAll();
      }
    });

    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return '';
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = bytes === 0 ? 0 : Math.floor(Math.log(bytes) / Math.log(1024));
      const v = bytes / Math.pow(1024, i);
      return v.toFixed(v >= 10 || i === 0 ? 0 : 1) + ' ' + sizes[i];
    }

    function friendlyName(url) {
      try {
        const u = new URL(url);
        const segments = u.pathname.split('/').filter(Boolean).map(s => decodeURIComponent(s.replace(/[-_]+/g, ' ')));
        if (segments.length) return capitalizeWords(segments[segments.length - 1]);
        return u.hostname.replace(/^www\./, '');
      } catch (e) {
        return '';
      }
    }

    function compactUrl(url) {
      try {
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./, '');
        const segments = u.pathname.split('/').filter(Boolean).slice(-2).map(s => decodeURIComponent(s.replace(/[-_]+/g, ' ')));
        const path = segments.join(' › ');
        return path ? host + ' · ' + capitalizeWords(path) : host;
      } catch (e) {
        return url;
      }
    }

    function capitalizeWords(str) {
      return str.replace(/\b\w+/g, txt => txt.charAt(0).toUpperCase() + txt.slice(1));
    }

    function fileLabel(name) {
      const ext = (name.split('.').pop() || '').toLowerCase();
      if (!ext) return 'FILE';
      return ext.slice(0, 4).toUpperCase();
    }

    function avatarText(item) {
      const base = item.type === 'file' ? (item.name || '') : (item.name || item.url || '');
      const sanitized = base.replace(/\.[a-z0-9]{2,6}$/i, '');
      const words = sanitized.split(/[\s_\-\/]+/).filter(Boolean).filter(word => /[\p{L}\p{N}]/u.test(word));
      if (!words.length) return '•';
      const initials = words.length >= 2 ? (words[0][0] + words[1][0]) : words[0].slice(0, 2);
      return initials.toUpperCase();
    }

    let drawerOpen = ownerMode;

    load();
  </script>
</body>
</html>
